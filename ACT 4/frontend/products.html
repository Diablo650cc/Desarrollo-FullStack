<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #6200ee;
            padding-bottom: 15px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        .header h1 {
            margin: 0;
            color: #6200ee;
            font-size: 28px;
        }

        .user-section {
            text-align: right;
            color: #e0e0e0;
        }

        .user-section p {
            margin-bottom: 10px;
            font-size: 14px;
        }

        .logout-btn {
            padding: 10px 20px;
            background-color: #6200ee;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background-color: #3700b3;
        }

        .container {
            display: grid;
            grid-template-columns: 400px 1fr; /* Ancho fijo para el formulario, el resto para productos */
            gap: 20px;
            margin-bottom: 20px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            flex: 1;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 350px 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .form-section {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.7);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .form-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            color: #fff;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
            color: #e0e0e0;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            background: #2b2b2b;
            color: #e0e0e0;
            transition: all 0.3s ease;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6200ee;
            box-shadow: 0 0 0 2px rgba(98, 0, 238, 0.3);
        }

        .form-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .btn-save {
            background-color: #6200ee;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-save:hover {
            background-color: #3700b3;
        }

        .btn-reset {
            background-color: #424242;
            color: white;
        }

        .btn-reset:hover {
            background-color: #616161;
        }

        .message {
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 6px;
            display: none;
            font-size: 14px;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background-color: #1b5e20;
            color: #81c784;
            border: 1px solid #4caf50;
        }

        .message.error {
            background-color: #b71c1c;
            color: #ef9a9a;
            border: 1px solid #ef5350;
        }

        .products-section {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.7);
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 500px; /* Altura mínima para mejor visualización */
        }

        .products-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            color: #fff;
        }

        .table-container {
            overflow-x: auto;
            flex: 1;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 600px; /* Evita que la tabla se comprima demasiado */
        }

        table thead {
            background-color: #2b2b2b;
            border-bottom: 2px solid #6200ee;
        }

        table th {
            padding: 14px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 13px;
            color: #e0e0e0;
            white-space: nowrap;
        }

        table td {
            padding: 14px 10px;
            border-bottom: 1px solid #333;
            font-size: 14px;
            color: #e0e0e0;
        }

        table tbody tr {
            transition: background-color 0.2s ease;
        }

        table tbody tr:hover {
            background-color: #2b2b2b;
        }

        table tbody tr:last-child td {
            border-bottom: none;
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-edit {
            background-color: #1976d2;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-edit:hover {
            background-color: #1565c0;
        }

        .btn-delete {
            background-color: #d32f2f;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-delete:hover {
            background-color: #b71c1c;
        }

        .empty-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.7);
        }

        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #fff;
        }

        .modal-content p {
            margin-bottom: 20px;
            color: #999;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn-cancel {
            background-color: #424242;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background-color: #616161;
        }

        .btn-confirm {
            background-color: #d32f2f;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-confirm:hover {
            background-color: #b71c1c;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1>Gestión de Productos</h1>
        <div class="user-section">
            <p style="margin: 0 0 10px 0;">Usuario: <strong id="userEmail">Cargando...</strong></p>
            <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container">
        <!-- FORM SECTION -->
        <div class="form-section">
            <h2>Nuevo Producto</h2>
            <div id="message" class="message"></div>

            <form id="productForm">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="nombre" placeholder="Nombre del producto" required>
                </div>

                <div class="form-group">
                    <label>Descripción</label>
                    <textarea id="descripcion" placeholder="Descripción"></textarea>
                </div>

                <div class="form-group">
                    <label>Categoría *</label>
                    <select id="categoria" required>
                        <option value="">-- Selecciona --</option>
                        <option value="Cascos">Cascos</option>
                        <option value="Chaquetas">Chaquetas</option>
                        <option value="Guantes">Guantes</option>
                        <option value="Botas">Botas</option>
                        <option value="Accesorios">Accesorios</option>
                        <option value="Electrónica">Electrónica</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Precio ($) *</label>
                    <input type="number" id="precio" placeholder="0.00" step="0.01" min="0" required>
                </div>

                <div class="form-group">
                    <label>Talla</label>
                    <input type="text" id="talla" placeholder="S, M, L, XL, etc.">
                </div>

                <div class="form-group">
                    <label>Color</label>
                    <input type="text" id="color" placeholder="Color">
                </div>

                <div class="form-group">
                    <label>Stock *</label>
                    <input type="number" id="stock" placeholder="0" value="0" min="0" required>
                </div>

                <div class="form-buttons">
                    <button type="submit" class="btn-save">Guardar Producto</button>
                    <button type="reset" class="btn-reset">Limpiar</button>
                </div>
            </form>
        </div>

        <!-- PRODUCTS SECTION -->
        <div class="products-section">
            <h2>Productos</h2>

            <!-- TABLE CONTAINER para scroll horizontal si es necesario -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th>Precio</th>
                            <th>Talla</th>
                            <th>Color</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr>
                            <td colspan="7" class="empty-message">No hay productos disponibles</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DELETE MODAL -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Confirmar eliminación</h3>
            <p>¿Estás seguro que deseas eliminar este producto?</p>
            <p style="color: #d32f2f; font-weight: bold;" id="deleteProductName"></p>
            <div class="modal-buttons">
                <button class="btn-cancel" id="cancelDelete">Cancelar</button>
                <button class="btn-confirm" id="confirmDelete">Eliminar</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let currentProductId = null;
        let productToDelete = null;

        // ELEMENTOS
        const productForm = document.getElementById('productForm');
        const message = document.getElementById('message');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmail = document.getElementById('userEmail');
        const productsTableBody = document.getElementById('productsTableBody');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        const confirmDeleteBtn = document.getElementById('confirmDelete');

        // ===== FUNCIONES =====
        function getToken() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
            }
            return token;
        }

        function showMessage(text, type = 'success') {
            message.textContent = text;
            message.className = `message show ${type}`;
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }

        function decodeJWT(token) {
            try {
                const payload = token.split('.')[1];
                return JSON.parse(atob(payload));
            } catch (e) {
                return null;
            }
        }

        function formatPrice(price) {
            return '$' + parseFloat(price).toFixed(2);
        }

        // ===== CARGAR USUARIO =====
        function loadUserInfo() {
            const token = getToken();
            const decoded = decodeJWT(token);
            if (decoded && decoded.email) {
                userEmail.textContent = decoded.email;
            }
        }

        // ===== CARGAR PRODUCTOS (READ) =====
        async function loadProducts() {
            try {
                const token = getToken();
                const res = await fetch(`${API_URL}/products`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Error al cargar productos');

                const products = await res.json();
                renderProducts(products);
            } catch (err) {
                showMessage('Error al cargar productos', 'error');
                console.error(err);
            }
        }

        function renderProducts(products) {
            if (products.length === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="7" class="empty-message">No hay productos disponibles</td></tr>';
                return;
            }

            productsTableBody.innerHTML = products.map(p => `
                <tr>
                    <td>${p.nombre}</td>
                    <td>${p.categoria}</td>
                    <td>${formatPrice(p.precio)}</td>
                    <td>${p.talla || '-'}</td>
                    <td>${p.color || '-'}</td>
                    <td>${p.stock}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-edit" onclick="editProduct('${p._id}')">Editar</button>
                            <button class="btn-delete" onclick="deleteProduct('${p._id}', '${p.nombre}')">Eliminar</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // ===== CREAR/ACTUALIZAR PRODUCTO (CREATE/UPDATE) =====
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const productData = {
                nombre: document.getElementById('nombre').value,
                descripcion: document.getElementById('descripcion').value,
                categoria: document.getElementById('categoria').value,
                precio: parseFloat(document.getElementById('precio').value),
                talla: document.getElementById('talla').value,
                color: document.getElementById('color').value,
                stock: parseInt(document.getElementById('stock').value)
            };

            try {
                const token = getToken();
                const method = currentProductId ? 'PUT' : 'POST';
                const url = currentProductId 
                    ? `${API_URL}/products/${currentProductId}`
                    : `${API_URL}/products`;

                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(productData)
                });

                if (!res.ok) throw new Error('Error al guardar');

                const msg = currentProductId ? 'Producto actualizado' : 'Producto creado';
                showMessage(msg, 'success');
                productForm.reset();
                currentProductId = null;
                document.querySelector('.btn-save').textContent = 'Guardar Producto';
                loadProducts();
            } catch (err) {
                showMessage('Error: ' + err.message, 'error');
            }
        });

        // ===== EDITAR PRODUCTO (READ ONE) =====
        window.editProduct = async function(id) {
            try {
                const token = getToken();
                const res = await fetch(`${API_URL}/products/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Error al cargar');

                const product = await res.json();
                document.getElementById('nombre').value = product.nombre;
                document.getElementById('descripcion').value = product.descripcion || '';
                document.getElementById('categoria').value = product.categoria;
                document.getElementById('precio').value = product.precio;
                document.getElementById('talla').value = product.talla || '';
                document.getElementById('color').value = product.color || '';
                document.getElementById('stock').value = product.stock || 0;

                currentProductId = id;
                document.querySelector('.btn-save').textContent = 'Actualizar Producto';
                showMessage('Editando producto', 'success');
            } catch (err) {
                showMessage('Error: ' + err.message, 'error');
            }
        }

        // ===== ELIMINAR PRODUCTO (DELETE) =====
        window.deleteProduct = function(id, name) {
            productToDelete = id;
            document.getElementById('deleteProductName').textContent = name;
            deleteModal.classList.add('show');
        }

        async function confirmDeleteProduct() {
            try {
                const token = getToken();
                const res = await fetch(`${API_URL}/products/${productToDelete}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Error al eliminar');

                showMessage('Producto eliminado', 'success');
                deleteModal.classList.remove('show');
                loadProducts();
            } catch (err) {
                showMessage('Error: ' + err.message, 'error');
            }
        }

        // ===== EVENTOS =====
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('authToken');
            window.location.href = '/login.html';
        });

        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.remove('show');
        });

        confirmDeleteBtn.addEventListener('click', confirmDeleteProduct);

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove('show');
            }
        });

        // ===== INICIALIZACIÓN =====
        window.addEventListener('load', () => {
            if (!localStorage.getItem('authToken')) {
                window.location.href = '/login.html';
                return;
            }
            loadUserInfo();
            loadProducts();
        });
    </script>
</body>
</html>